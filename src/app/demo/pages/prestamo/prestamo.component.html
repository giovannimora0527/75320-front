<div class="container">
    <div class="card">
      <div class="card-header">
        <div class="row">
          <div class="col">
            <button class="btn btn-outline-primary" (click)="crearPrestamoModal('C')" title="Crear nuevo préstamo">
              <i class="fa fa-plus"></i> &nbsp;Nuevo Préstamo
            </button>
          </div>
        </div>
      </div>
  
      <div class="card-body">
        <div class="row">
          <div class="col">
            <div class="card">
              <div class="card-body">
                <div class="table table-responsive">
                  <table class="table table-stripped">
                    <thead>
                      <tr>
                        <th>Libro</th>
                        <th>Usuario</th>
                        <th>Fecha Préstamo</th>
                        <th>Fecha Devolución</th>
                        <th>Estado</th>
                        <th class="text-center">Opciones</th>
                      </tr>
                    </thead>
                    <tbody *ngIf="prestamos.length === 0">
                      <tr>
                        <td colspan="6" class="text-center">No hay préstamos registrados</td>
                      </tr>
                    </tbody>
                    <tbody *ngIf="prestamos.length > 0">
                      <tr *ngFor="let prestamo of prestamos">
                        <td>{{ getTituloLibro(prestamo.libro) }}</td>
                        <td>{{ getNombreUsuario(prestamo.usuario) }}</td>
                        <td>{{ prestamo.fechaPrestamo ? (dateFromString(prestamo.fechaPrestamo) | date:'shortDate') : '' }}</td>
                        <td>{{ prestamo.fechaDevolucion | date:'shortDate' }}</td>
                        <td>
                          <span [ngClass]="obtenerColorEstado(prestamo)">
                            {{ obtenerEstado(prestamo) }}
                          </span>
                        </td>
                        <td class="text-center">
                          <button class="btn btn-outline-primary btn-sm" (click)="abrirModoEdicion(prestamo)" title="Editar">
                            <i class="fa fa-edit"></i> &nbsp;Editar
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Modal crear/actualizar préstamo -->
    <div class="modal fade" id="modalPrestamo" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-md">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                {{ modoFormulario === 'C' ? 'Registrar Préstamo' : 'Editar Préstamo' }}
              </h5>
              <button type="button" class="btn-close" (click)="cerrarModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form [formGroup]="form">
                <div *ngIf="modoFormulario === 'C'" class="mb-3">
                  <label class="form-label">Libro</label>
                  <select class="form-select" formControlName="libro" [disabled]="libros.length === 0">
                    <option [ngValue]="null">Seleccione un libro</option>
                    <option *ngFor="let libro of libros" [ngValue]="libro">{{ libro.titulo }}</option>
                  </select>
                </div>
      
                <div *ngIf="modoFormulario === 'C'" class="mb-3">
                  <label class="form-label">Usuario</label>
                  <select class="form-select" formControlName="usuario">
                    <option [ngValue]="null">Seleccione un usuario</option>
                    <option *ngFor="let usuario of usuarios" [ngValue]="usuario">{{ usuario.nombre }}</option>
                  </select>
                </div>
      
                <div *ngIf="modoFormulario === 'C'" class="mb-3">
                  <label class="form-label">Fecha Devolución</label>
                  <input type="date" class="form-control" formControlName="fechaDevolucion" />
                  <div *ngIf="form.get('fechaDevolucion')?.errors?.['invalidDate'] && form.get('fechaDevolucion')?.touched" class="text-danger">
                    La fecha de devolución no puede ser menor que la de préstamo.
                  </div>
                </div>
      
                <div *ngIf="modoFormulario === 'EE'" class="mb-3">
                  <label class="form-label">Fecha de entrega</label>
                  <input type="date" class="form-control" formControlName="fechaEntrega" />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
              <button *ngIf="modoFormulario === 'C'" class="btn btn-primary" (click)="guardar()" [disabled]="form.invalid">
                Guardar
              </button>
              <button *ngIf="modoFormulario === 'EE'" class="btn btn-primary" (click)="guardar()" [disabled]="form.get('fechaEntrega')?.invalid">
                Editar Préstamo
              </button>
            </div>
          </div>
        </div>
      </div>