<ngx-spinner bdColor="rgba(51,51,51,0.8)" size="medium" color="#fff" type="pacman" [fullScreen]="true">
    {{ msjSpinner }}...
</ngx-spinner>

<div class="container">
    <div class="card">
        <div class="card-header">
            <div class="row">
                <div class="col">
                    <button class="btn btn-outline-primary" (click)="abrirModalCrear()"
                        title="Registrar nuevo préstamo">
                        <i class="fa fa-plus"></i>
                        &nbsp;Nuevo Préstamo
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <div class="table table-responsive">
                                <table class="table table-responsive table-striped">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Libro</th>
                                            <th>Fecha Préstamo</th>
                                            <th>Fecha Devolución</th>
                                            <th>Fecha Entrega</th>
                                            <th>Estado</th>
                                            <th class="text-center">Opciones</th>
                                        </tr>
                                    </thead>
                                    <tbody *ngIf="prestamos.length === 0">
                                        <tr>
                                            <td colspan="7" class="text-center">No hay préstamos registrados</td>
                                        </tr>
                                    </tbody>
                                    <tbody *ngIf="prestamos.length > 0">
                                        <tr *ngFor="let p of prestamos">
                                            <td>{{p.usuario?.nombreUsuario || 'Sin usuario' }}</td> <!-- Cambio aquí -->
                                            <td>{{ p.libro?.titulo || 'Sin libro' }}</td> <!-- Cambio aquí -->
                                            <td>{{ p.fechaPrestamo | date:'yyyy-MM-dd' }}</td> <!-- Cambio aquí -->
                                            <td>{{ p.fechaDevolucion | date:'yyyy-MM-dd' }}</td> <!-- Cambio aquí -->
                                            <td>{{ p.fechaEntrega ? (p.fechaEntrega | date:'yyyy-MM-dd') : 'Sin
                                                entregar' }}</td> <!-- Cambio aquí -->
                                            <td>{{ p.estadoPrestamo}}</td> <!-- Cambio aquí -->
                                            <td class="text-center">
                                                <button class="btn btn-outline-primary btn-sm" title="Editar entrega"
                                                    (click)="abrirModalEditar(p)">
                                                    <i class="fa fa-edit"></i>
                                                    &nbsp;Editar Entrega
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para registrar préstamo y editar entrega -->
<div class="modal fade" id="crearPrestamoModal" tabindex="-1" aria-labelledby="crearPrestamoModalLabel"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ accion }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="form">
                    <!-- Solo se muestra en modo Crear -->
                    <div *ngIf="modoFormulario === 'C'">
                        <div class="mb-3">
                            <label class="form-label">Usuario</label>
                            <select class="form-select" formControlName="usuarioId">
                                <option *ngFor="let u of usuarios" [value]="u.id">{{ u.nombreUsuario }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Libro</label>
                            <select class="form-select" formControlName="libroId">
                                <option *ngFor="let l of libros" [value]="l.id">{{ l.titulo }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fecha Devolución</label>
                            <input type="date" class="form-control" formControlName="fechaDevolucion">
                        </div>
                    </div>

                    <!-- Solo se muestra en modo Editar -->
                    <div *ngIf="modoFormulario === 'E'">
                        <div class="mb-3">
                            <label class="form-label">Fecha Entrega</label>
                            <input type="date" class="form-control" formControlName="fechaEntrega">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
                <button type="button" class="btn btn-primary" (click)="guardarPrestamo()">Registrar Préstamo</button>
            </div>
        </div>
    </div>
</div>